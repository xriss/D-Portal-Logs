<html>
  <head>
	<title>D-Portal Xpath stats</title>
	<style>
	</style>
	<script
		src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
	<script>
		var stats
		$.getJSON("stats.json", function(json) {
			stats=json
			$(insert_page)
		})

var insert_page=function()
{
	let chartidx=0
	
	let latest=0

//	console.log( Object.keys(stats.xpath).length + " xpaths stats found " )

	for(let path of Object.keys(stats.xpath).sort() )
	{
		let pdat=stats.xpath[path]

//		console.log(path)
		
		let it=$("<div/>")
		$("body").append(it)
		
		let pathlink="http://reference.iatistandard.org/203/activity-standard"+(path.split("@")[0])
		
		it.append(`<h1><a target="_blank" id="${path}" href="${pathlink}">${path}</a></h1>`)
		
		let tab=$(`<table style="width:100%"/>`)
		it.append(tab)
		
		let thead=$("<tr/>")
		tab.append(thead)
		
		thead.append("<th>Rank</ht>")
		thead.append("<th>Count</ht>")
		thead.append("<th>Value</ht>")
		thead.append("<th>Example Publisher</ht>")
		thead.append("<th>Example Activity</ht>")
		
		for(let idx=0;idx<pdat.top.length;idx++)
		{
			let v=pdat.top[idx]
			let trow=$("<tr/>")
			tab.append(trow)

			trow.append("<td>"+(idx+1)+"</hd>")
			trow.append("<td>"+v.count+"</hd>")
			trow.append("<td>"+v.value+"</hd>")

			let url="http://d-portal.org/ctrack.html?publisher="+v.pid+"#view=main"
			trow.append(`<td><a target="_blank" href="${url}">${v.pid}</a></hd>`)

			url="http://d-portal.org/ctrack.html#view=act&aid="+v.aid
			trow.append(`<td><a target="_blank" href="${url}">${v.aid}</a></hd>`)
		}
   
   		let cnames=["count","activities","publishers","distinct"]

		for(let cname of cnames)
		{

			chartidx++

			let data=[]
			
			for(let n of Object.keys(pdat[cname]).sort() )
			{
				let v=pdat[cname][n]
				let d=parseInt(n)
				if(d>latest){latest=d} // remember latest date we have seen
				data.push( {x: new Date(d), y: v} )
			}

			let cdiv=$(`<div style="width:50%;height:360px;display:inline-block;" />`)
			it.append(cdiv)
			cdiv.append(`<h2>${cname}<h2>`)
			cdiv.append(`<div id="chart${chartidx}" style="height:320px" />`)

			let confs={
				axisX: {
				type: Chartist.FixedScaleAxis,
				divisor: 5,
				labelInterpolationFnc: function(value) {
					return moment(value).format('YYYY MMM D');
					}
				}
			}
			let datas={
			  series: [
				{
					data:data
				}
			  ]
			}

			let chart=new Chartist.Line( "#chart"+chartidx, datas , confs );

		}
	}


	let it=$("<div/>")
	$("body").append(it)

	it.append(`<h1>Percentage of activities that include data for each valid xpath</h1>`)

	let tab=$(`<table style="width:100%"/>`)
	it.append(tab)
	
	let thead=$("<tr/>")
	tab.append(thead)
	
	thead.append("<th>Xpath</ht>")
	thead.append("<th>Popularity</ht>")
	
	
	
	let atotal=0
	let a=[]
	for(let path of Object.keys(stats.xpath).sort() )
	{
		let p=stats.xpath[path]
		let count=parseInt(p.activities[latest])
		if(atotal<count){atotal=count} // highest
		a.push({path:path,count:count})
	}
	for(let v of a) // convert to 00.00 pct
	{
		v.pct=Math.ceil(10000*(v.count/atotal))/100
	}
	a.sort( function(a,b){ return a.count<b.count} )
	
	for(let i=0;i<a.length;i++)
	{
		let t=a[i]
		let trow=$("<tr/>")
		tab.append(trow)

		trow.append(`<td><a target="_blank" href="#${t.path}">${t.path}</a></hd>`)
		trow.append(`<td>${t.pct}%</hd>`)
	}

}

	</script>
 </head>
  <body>
  </body>
</html>
