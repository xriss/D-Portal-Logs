<html>
  <head>
	<title>D-Portal Xpath Stats</title>
	<style>
		*		{box-sizing:border-box;}
		body	{margin:5em 0 auto; font-family:sans-serif; color:#111; position:relative;}
		table	{border-spacing:0; table-layout:fixed;}
		th		{text-align:left; padding:0 20px 10px 20px; border-bottom:1px solid #ccc; color:#666; font-size:12px; text-transform:uppercase;}
		th.rank	{width:5%;}
		th.count{width:10%;}
		th.val	{width:35%; overflow-wrap:break-word;}
		th.pub	{width:25%;}
		th.act	{width:25%; overflow-wrap:break-word;}
		th.xpath{width:85%;}
		th.pop	{width:15%;}
		td		{padding:10px 20px; border-bottom:1px solid #ccc; vertical-align:top;}
		td:first-of-type	{color:#666;}
		td:nth-of-type(2)	{font-family:monospace; font-size:16px;}
		td:last-of-type		{word-break:break-all;}
		
		a			{color:#6188e2; text-decoration:none;}
		a:link		{color:#6188e2;}
		a:visited	{color:#6188e2;}
		a:hover		{color:#004dff;}
		a:active	{color:#6188e2;}
		
		.wrap, .pid_title_wrap	{width:960px; margin:auto; padding-bottom:3em;}
		.graphs	{display:inline-block; vertical-align:top; box-sizing:border-box; width:50%; height:420px;}
		.graphs:nth-of-type(odd)	{padding:2em 1.5em 0 0;}
		.graphs:nth-of-type(even)	{padding:2em 0 0 1.5em;}
		.graphs:nth-of-type(3), .graphs:nth-of-type(4)	{padding-top:0;}
		.graphs h2	{color:#666; font-size:14px; text-transform:uppercase;}
		
		a.element		{display:block; font-size:24px; margin-bottom:20px; color:#6188e2; text-decoration:none; font-weight:bold; font-family:monospace; padding-bottom:1em;}
		a.element:hover	{color:#004dff;}
		
		.percent		{width:960px; margin:auto; margin-bottom:3em;}
		.percent span	{display:block; font-size:24px; color:#666; padding-bottom:1em;}
		
		/*	Navigation bar and links	*/
		.nav_wrap			{width:100%; position:absolute; top:-5em; left:0; background-color:#ddd; height:initial; min-height:40px;}
		.nav				{width:100%; position:fixed; top:0; left:0; background-color:#ddd; height:initial; min-height:40px; z-index:666;}
		.left_nav,
		.right_nav			{display:inline-block; width:50%; height:40px; vertical-align:top;}
		.right_nav			{text-align:right;}
		a.home_link,
		a.log_link,
		a.git_link,
		a.about_link		{display:inline-block; padding:12px 20px 8px 20px; border-bottom:3px solid #ddd; color:#444; text-decoration:none; font-family:sans-serif; font-size:14px;}
		a.home_link:hover,
		a.log_link:hover,
		a.git_link:hover,
		a.about_link:hover	{border-bottom:3px solid #6188e2; cursor:pointer;}
		a.git_link 			{text-transform:uppercase; font-size:11px; line-height:16px;}
		
		/*	Back to top link	*/
		a.top		{display:block; width:100%; padding:20px 0; text-align:center; font-size:16px; color:#444; text-decoration:none; position:absolute; bottom:-100px; left:0;}
		a.top:hover	{background-color:#eee;}
		
		.ct-chart-line	{ overflow:visible; }

.chartist-tooltip {
  position: absolute;
  display: inline-block;
  opacity: 0;
  min-width: 5em;
  padding: .5em;
  background: #F4C63D;
  color: #453D3F;
  font-family: Oxygen,Helvetica,Arial,sans-serif;
  font-weight: 700;
  text-align: center;
  pointer-events: none;
  z-index: 1;
  -webkit-transition: opacity .2s linear;
  -moz-transition: opacity .2s linear;
  -o-transition: opacity .2s linear;
  transition: opacity .2s linear; }
  .chartist-tooltip:before {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    width: 0;
    height: 0;
    margin-left: -15px;
    border: 15px solid transparent;
    border-top-color: #F4C63D; }
  .chartist-tooltip.tooltip-show {
    opacity: 1; }

.ct-area, .ct-line {
  pointer-events: none; }

	</style>
	<script
		src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="https:////cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartist-plugin-tooltips@0.0.17/dist/chartist-plugin-tooltip.min.js"></script>
	<script>

// goto hash
var goto_hash=function()
{
	if( window.location.hash=="" || window.location.hash=="#" ) // default
	{
		window.location.hash="#/iati-activities/iati-activity/iati-identifier"
	}
	
	let s=window.location.hash
	
	document.getElementById( s.substring(1) ).scrollIntoView(true)
//	window.scrollBy(0,-50)
}


// parrams
var queryed = {};
if (location.search) location.search.substr(1).split("&").forEach(function(item) {
	var s = item.split("=")
	var k = s[0]
	var v = s[1] && decodeURIComponent(s[1]);
	queryed[k]=v
})

		var stats
		
		if(queryed.pid)
		{
			$.getJSON("pids/"+queryed.pid+".json", function(json) {
				stats=json
				
				//convert pid to name from data
				queryed.pname = stats.xpath["/iati-activities/iati-activity/reporting-org/narrative"].top[0].value
				
				let it=$(`<div class='pid_title'><h1>${queryed.pid} : ${queryed.pname}</h1></>`)
				$(".pid_title_wrap").append(it)

				$(()=>{
					insert_page()
					goto_hash()
				})
			})
		}
		else
		{
			$.getJSON("stats.json", function(json) {
				stats=json
				$(()=>{
					insert_page()
					goto_hash()
				})
			})
		}

var insert_page=function()
{
	let chartidx=0
	
	let latest=0

//	console.log( Object.keys(stats.xpath).length + " xpaths stats found " )

	for(let path of Object.keys(stats.xpath).sort() )
	{
		let pdat=stats.xpath[path]

//		console.log(path)
		
		let it=$("<div class='wrap'/>")
		$("body").append(it)
		
		let pathlink="http://reference.iatistandard.org/203/activity-standard"+(path.split("@")[0])
		if(path.startsWith("/iati-organisations")) // org files
		{
			pathlink="http://reference.iatistandard.org/203/organisation-standard"+(path.split("@")[0])
		}
		
		it.append(`<a class="element" target="_blank" id="${path}" href="${pathlink}">${path}</a>`)

// check some data exists
		let max_count=0
		if(pdat.count)
		{
			for(let n in pdat.count )
			{
				let count=pdat.count[n]
				if(count>max_count){max_count=count}
			}
		}
		if( max_count == 0 )
		{
			it.append(`<div>No data published.</div>`)
		}
		else
		{

			let tab=$(`<table style="width:100%"/>`)
			it.append(tab)
			
			let thead=$("<tr/>")
			tab.append(thead)
			
			thead.append("<th class='rank'>Rank</th>")
			thead.append("<th class='count'>Count</th>")
			thead.append("<th class='val'>Value</th>")
			if(!queryed.pid)
			{
				thead.append("<th class='pub'>Example Publisher</th>")
			}
			thead.append("<th class='act'>Example Activity</th>")
			
			for(let idx=0;idx<pdat.top.length;idx++)
			{
				let v=pdat.top[idx]
				let trow=$("<tr/>")
				tab.append(trow)

				trow.append("<td>"+(idx+1)+"</td>")
				trow.append("<td>"+v.count+"</td>")
				trow.append("<td>"+v.value+"</td>")

				if(!queryed.pid)
				{
					if(v.pid)
					{
						let url="http://d-portal.org/ctrack.html?publisher="+v.pid+"#view=main"
						trow.append(`<td><a target="_blank" href="${url}">${v.pid}</a></td>`)
					}
					else
					{
						trow.append(`<td></td>`)
					}
				}

				if(v.aid)
				{
					url="http://d-portal.org/ctrack.html#view=act&aid="+v.aid
					trow.append(`<td><a target="_blank" href="${url}">${v.aid}</a></td>`)
				}
				else
				{
					trow.append(`<td></td>`)
				}
			}
	   
			let cnames=["count","activities","publishers","distinct"]

			for(let cname of cnames)
			{
				if(!pdat[cname]) { continue } // publishers have one less graph

				chartidx++

				let data=[]
				
				let clast
				for(let n of Object.keys(pdat[cname]).sort() )
				{
					let v=pdat[cname][n]
					let d=parseInt(n)
					if(d>latest){latest=d} // remember latest date we have seen
					data.push( {x: new Date(d*8.64e+7), y: v} )
					clast=v
				}

				let cdiv=$(`<div class="graphs"/>`)
				it.append(cdiv)
				let cval=(clast/1).toLocaleString("en", { useGrouping: true })
				cdiv.append(`<h2>${cname} = ${cval}</h2>`)
				cdiv.append(`<div id="chart${chartidx}" style="height:320px;position:relative;" />`)

				let confs={
					axisX: {
					type: Chartist.FixedScaleAxis,
					divisor: 5,
					labelInterpolationFnc: function(value) {
						return moment(value).format('YYYY MMM D');
						}
					},
					plugins: [
						Chartist.plugins.tooltip({
							transformTooltipTextFnc:(it)=>{
								let aa=it.split(",")
								return moment(aa[0]/1).format('YYYY MMM D')+" : "+
								(aa[1]/1).toLocaleString("en", { useGrouping: true })
							}
						})
					],
  				}
				let datas={
				  series: [
					{
						data:data
					}
				  ]
				}

				let chart=new Chartist.Line( "#chart"+chartidx, datas , confs );

			}
		}
	}


	
	let idx=0
	for( let group of ["/iati-organisations/iati-organisation","/iati-activities/iati-activity"] )
	{
		idx++
		
		let it=$(`<div id='percentage${idx}' class='percent'/>`)
		$("body").append(it)

		it.append(`<span>Percentage of ${group} that include  data for each valid xpath</span>`)

		let tab=$(`<table style="width:100%"/>`)
		it.append(tab)
		
		let thead=$("<tr/>")
		tab.append(thead)
		
		thead.append("<th class='xpath'>Xpath</th>")
		thead.append("<th class='pop'>Popularity</th>")


		let atotal=0
		let a=[]
		for(let path of Object.keys(stats.xpath).sort() )
		{
			if(path.startsWith(group))
			{
				let p=stats.xpath[path]
				let count=parseInt(p.activities[latest])
				if(path.startsWith("/iati-organisations")) // org files
				{
					count=parseInt(p.publishers[latest])
				}
				if(atotal<count){atotal=count} // highest
				a.push({path:path,count:count})
			}
		}
		for(let v of a) // convert to 00.00 pct
		{
			v.pct=Math.ceil(10000*(v.count/atotal))/100
		}
		a.sort( function(a,b){ return a.pct<b.pct ? 1 : -1 } )
		
		for(let t of a)
		{
			let trow=$("<tr/>")
			tab.append(trow)

			trow.append(`<td><a href="#${t.path}">${t.path}</a></td>`)
			trow.append(`<td>${t.pct}%</td>`)
		}
		
	}

}

	</script>
 </head>
  <body>
	<div class="nav_wrap" id="top">
		<div class="nav">
			<div class="left_nav">
				<a class="home_link" href="./index.html">Home</a><a class="about_link" href="#percentage1">Percentage of elements used</a>
			</div><div class="right_nav">
				<span>Please be aware that these pages take awhile to load.</span><a class="log_link" href="./logs.html">Logs</a><a class="stat_link" href="./xpath.html">Xpath Stats</a><a class="git_link" href="https://github.com/xriss/D-Portal-Logs">Github</a>
			</div>
		</div>
	</div>
	<div class="pid_title_wrap">
	<a href="#top" class="top">BACK TOP</a>
  </body>
</html>
