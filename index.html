<html>
  <head>
	<title>D-Portal Logs</title>
	<style>
		  *		{box-sizing:border-box;}
		  body	{padding:30px; margin:0 auto; color:#111; word-break:break-word; position:relative;}
		  div	{width:440px; height:240px; margin:0 auto; display:inline-block; vertical-align:top; padding:20px;}
		  h1	{font-family:monospace; text-transform:uppercase; font-size:1.5em;}
		  p		{padding:10px 0;}
		  pre	{display:inline; margin:0; white-space:initial;}
		  b		{font-weight:bold;}
		  
		  /*	Navigation bar and links	*/
		  .nav	{width:100%; position:absolute; top:0; left:0; background-color:#444; height:initial; min-height:40px;}
		  
		  a.git_link,
		  a.about_link		{display:block; height:40px; position:absolute; top:0; padding:10px 20px; background-color:#444; color:#fff; text-decoration:none; font-family:sans-serif; font-size:14px;}
		  a.about_link		{left:0;}
		  a.git_link		{right:0;}
		  a.git_link:hover, a.about_link:hover	{background-color:#555; cursor:pointer;}
		  
		  
		  /*	Stats and Chart Wrappers	*/
		  .wrap	{display:inline-block; vertical-align:top; width:20%; height:initial; margin-bottom:20px;}
		  .wrap div:first-of-type span	{border-top:1px solid #ccc;}
		  .wrap div:last-child span		{border-bottom:1px solid #ccc;}
		  
		  .chart_wrap	{display:block; width:initial; height:initial; margin-top:20px;}

		   /*	Stats styles	*/
		  .stat	{display:table; table-layout:fixed; width:100%; height:initial; text-transform:capitalize; font-family:sans-serif; font-size:16px; border:0px solid #ccc; border-bottom:0; border-right:0; padding:0;}

		  .stat span				{display:table-cell; padding:10px 20px; border-right:1px solid #ccc;}
		  .stat span:first-of-type	{width:40%; border-left:1px solid #ccc; text-align:right;}
		  .stat:nth-of-type(even)	{background-color:#eee;}
		  
		  /*	Overview styles	*/
		  .overview			{display:none; margin-top:30px; width:500px; height:initial; min-height:100%; font-family:sans-serif; border:1px solid #ccc; padding:20px 40px; line-height:24px;}
		  .overview span	{display:block;}
		  
		  /*	Legend styles	*/
		  table {width:100%; padding:20px 0 10px 0;}
		  td	{padding:5px 0;}
		  td:first-of-type		{font-weight:bold; font-size:14px; min-width:150px;}
		  tr:nth-of-type(even)	{background-color:#eee;}
		  td:nth-of-type(2)	{font-family:monospace;}
		  
		  
		  /*	Mobile-Last		*/
			@media screen and (max-width: 1024px) {
				body	{margin:0 auto; width:100%; padding-top:80px; font-size:30px;}
				.wrap, .overview	{display:block; width:100%; height:initial;}
				.nav, a.git_link, a.about_link	{height:65px;}
				td:first-of-type	{min-width:300px;}
				.nav, a.git_link, a.about_link, td:first-of-type	{font-size:30px; line-height:42px;}
				.overview span, td:nth-of-type(2)	{font-size:24px; line-height:42px;}
				h1, .stat span	{font-size:42px; line-height:64px;}
			}
		  
	</style>
	<script
		src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	 <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js"></script>
 </head>
  <body>
	<script>
		
var addchart=function(data,opts){
 
	var div=$('<div> <canvas></canvas> </div>')
	$("body").append(div)
	var ctx=div.children(":first")[0].getContext("2d");

	var dl=[]
	var dv=[]
	var idx=0
	for(var n in data){
		dl[idx]=(new Date(Number(n)*8.64e7)).toLocaleDateString()
		dv[idx]=data[n]
		idx++
	}
	
var config = {
	type: 'line',
	data: {
		labels: dl,
		datasets: [{
			label: opts.name || "Filled",
			backgroundColor: opts.color || "#f44",
			borderColor: opts.color || "#f44",
			data: dv,
			fill: true,
		}]
	},
	options: {
		responsive: true,
		title:{
			display:opts.title && true || false,
			text:opts.title || 'Chart.js Line Chart',
			fontSize:14
		},
		tooltips: {
			mode: 'index',
			intersect: false,
		},
		hover: {
			mode: 'nearest',
			intersect: true
		},
		scales: {
			xAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Day'
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Amount'
				}
			}]
		}
	}
};

   return new Chart(ctx, config);
};

$.getJSON("stats.json", function(json) {


// Snapshots

var div=$('<div class="wrap"><h1> DATABASE </h1></div>')
$("body").append(div)

for(var n in json.count)
{
	var h=0;	// h = highest
	
	for(var q in json.count[n])
	{
		if (q > h)
		{
			h = q;
		}
	}
	
	var number = Number(json.count[n][h]);	
	var div2=$('<div class="stat"><span>'+(number.toLocaleString())+'</span><span>'+n+'</span></div>')
	div.append(div2)
}

for(var n in json.distinct)
{
	var div=$('<div class="wrap"><h1> '+n+' </h1></div>')
	$("body").append(div)
	
	for(var t in json.distinct[n])
	{
		var h=0;	// h = highest
		
		for(var q in json.distinct[n][t])
		{
			if (q > h)
			{
				h = q;
			}
		}
		
		var number = Number(json.distinct[n][t][h]);	
		var div2=$('<div class="stat"><span>'+(number.toLocaleString())+'</span><span>'+t+'</span></div>')
		div.append(div2)
	}
}


// Charts

var div=$('<div class="chart_wrap"><h1> DATABASE </h1></div>')
$("body").append(div)

for(var n in json.count)
{
	window["chartjs_"+n]=
        addchart(json.count[n],
            {title:"Total "+n+" table entries recorded in the database",name:n,color:"#000"});
}


for(var n in json.distinct)
{
	var div=$('<div class="chart_wrap"><h1> '+n+' TABLE </h1></div>')
	$("body").append(div)

   for(var t in json.distinct[n])
	{
		window["chartjs_"+n+"_"+t]=
            addchart(json.distinct[n][t],
                {title:"Distinct "+t+" values recorded in "+n+" ",name:n+"."+t,color:"#444"});
	}

}

});

	</script>
	<div class="nav">
		<a class="git_link" href="https://github.com/xriss/D-Portal-Logs">Source code for D-Portal-Logs is on Github</a><a onclick="$('.overview').toggle();" class="about_link"><b>&#9730; What is this?</b></a>
	</div>
	<div class="overview">
		<h1>OVERVIEW</h1>
		<span>Statistics &amp; graphs of the <a href="http://d-portal.org" target="_blank">D-Portal</a> database. Figures in the corresponding tables are daily logs of nightly imports. The graphs show these figures over time; hover over the points for more information.</span>
		<h1>LEGEND</h1>
		<span>Any linked definitions below are to the IATI Registry.</span>
		<h1>DATABASE</h1>
		<span>These are tables found in the database. Numbers are total entries found in these tables.</span>		
		<table>
			<tr>
				<td>Act</td><td>Activities table</td>
			</tr>
			<tr>
				<td>Budget</td><td>Budgets table</td>
			</tr>
			<tr>
				<td>Country</td><td>Countries table</td>
			</tr>
			<tr>
				<td>Element</td><td>XML elements</td>
			</tr>
			<tr>
				<td>Location</td><td>Locations table</td>
			</tr>
			<tr>
				<td>Related</td><td>Related activities table</td>
			</tr>
			<tr>
				<td>Sector</td><td>Sectors table</td>
			</tr>
			<tr>
				<td>Slug</td><td>IATI Registry slug (metadata)</td>
			</tr>
			<tr>
				<td>Trans</td><td>Transactions table</td>
			</tr>
		</table>		
		<h1>TABLES</h1>
		<span>Number of <b>distinct</b> (unique) values in the column; ie. repeated values are not counted.</span>	
		<table>
			<tr>
				<td>Aid</td><td><a href="http://iatistandard.org/202/activity-standard/iati-activities/iati-activity/iati-identifier/">iati-identifier</a></td>
			</tr>
			<tr>
				<td>Flags</td><td>Internal flags</td>
			</tr>
			<tr>
				<td>Spend_*</td><td>USD currency is the default</td>
			</tr>
			<tr>
				<td>Day_length</td><td>( Day_end - Day_start ) &#8815; than a year</td>
			</tr>
			<tr>
				<td>Status_code</td><td><a href="http://iatistandard.org/202/activity-standard/iati-activities/iati-activity/activity-status/">activity-status</a></td>
			</tr>
			<tr>
				<td>Country</td><td><a href="http://iatistandard.org/202/activity-standard/iati-activities/iati-activity/recipient-country/">recipient-country</a></td>
			</tr>
			<tr>
				<td>*_percent</td><td>Percentage of activities should always add up to 100% even when reported otherwise</td>
			</tr>
			<tr>
				<td>Element_*</td><td>IATI element hierarchies</td>
			</tr>
			<tr>
				<td>Element_volume</td><td>Total number of elements</td>
			</tr>
			<tr>
				<td>Location</td><td><a href="http://iatistandard.org/202/activity-standard/iati-activities/iati-activity/location/">location</a></td>
			</tr>
			<tr>
				<td>Related_aid</td><td><a href="http://iatistandard.org/202/activity-standard/iati-activities/iati-activity/related-activity/">related-activity</a></td>
			</tr>
			<tr>
				<td>Sector_code</td><td><a href="http://iatistandard.org/202/codelists/Sector/">DAC 5 Digit Sector</a></td>
			</tr>
			<tr>
				<td>Sector_group</td><td><a href="http://iatistandard.org/202/codelists/SectorCategory/">DAC 3 Digit Sector</a></td>
			</tr>
			
		</table>
	</div>
  </body>
</html>
